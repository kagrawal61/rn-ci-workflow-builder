name: React Native Build Pipeline
'on':
  pull_request:
    branches:
      - develop
  workflow_dispatch: {}
env: {}
permissions:
  contents: read
  pull-requests: write
  issues: write
jobs:
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: SampleRNApp
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: yarn
      - name: Install
        run: yarn install --immutable
      - name: Verify Android Environment
        id: android-env-check
        run: |

          # Check for required directories and files
          echo "🔍 Verifying Android project setup..."

          if [ ! -d "android" ]; then
            echo "❌ Error: Android directory not found"
            echo "Make sure you're running this workflow from the root"
            echo "of a React Native project"
            exit 1
          fi

          if [ ! -f "android/gradlew" ]; then
            echo "⚠️ Warning: Gradle wrapper not found at android/gradlew"
            echo "Build may fail if Gradle wrapper is not properly set up"
          fi

          echo "✅ Android environment looks good"
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle
      - name: Make Gradlew Executable
        run: chmod +x android/gradlew
      - name: Run Android Build
        id: android-build
        run: |

          echo "🚀 Starting Android build for release..."

          # Check for .env file and use it if exists
          if [ -f ".env" ]; then
            echo "✅ Found .env file, will be used for the build"
          else
            echo "⚠️ No .env file found in project root"
          fi

          # Run the build with error capture
          echo "Building Android app using official React Native CLI..."

          # Using direct Gradle commands for more reliable builds
          echo "Using Gradle task: assembleRelease for release build with apk output format"

          # Using direct Gradle command
          cd android
          ./gradlew assembleRelease || {
            echo "❌ Android build failed"
            echo "::error::Android build failed. Check logs for details."
            exit 1
          }
          cd ..

          echo "✅ Android build completed successfully"

          # Verify the expected outputs based on output type
          if ls android/app/build/outputs/apk/**/*.apk 1> /dev/null 2>&1; then
            echo "✅ APK files generated successfully"
          else
            echo "⚠️ Warning: Expected APK files not found. Storage steps may fail."
          fi
      - name: Upload Android Artifact
        id: artifact-upload-android
        if: success()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: SampleRNApp/android/app/build/outputs/apk/**/*.apk
          retention-days: 30
      - name: Fetch Android Artifact URLs
        id: fetch-android-artifacts
        if: success()
        run: >

          # Fetch artifact information for this run
          echo "Fetching artifact information..."
          ARTIFACTS_JSON=$(gh api /repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts
          --paginate)
          echo "artifact_data=${ARTIFACTS_JSON}" >> $GITHUB_OUTPUT


          # Extract artifact names and IDs

          echo "Extracting artifact URLs..."

          ARTIFACT_LIST=""

          echo "${ARTIFACTS_JSON}" | jq -r '.artifacts[] | "- [" + .name + "](\"${{ github.server_url }}/${{
          github.repository }}/actions/runs/${{ github.run_id }}/artifacts/" + (.id|tostring) + ")"' >
          artifact_links.txt

          if [ -s artifact_links.txt ]; then
            ARTIFACT_LIST=$(<artifact_links.txt)
            echo "artifact_list<<EOF" >> $GITHUB_OUTPUT
            echo "${ARTIFACT_LIST}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "artifact_list=No artifacts found" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}      
      - name: Determine PR Status
        id: build-source
        run: |

          # Determine if this is a PR or a direct push (simplified for PR comments only)
          EVENT_NAME="${{ github.event_name }}"
          if [[ "$EVENT_NAME" == "pull_request" ]] || [[ "$EVENT_NAME" == "pull_request_target" ]]; then
            # This is a PR - set output flag
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "📌 Running on PR #${{ github.event.pull_request.number }} from branch ${{ github.head_ref }}"
          else
            # This is a direct push - set output flag
            echo "is_pr=false" >> $GITHUB_OUTPUT
            echo "📌 Running on branch ${{ github.ref_name }}"
          fi
      # GitHub CLI is pre-installed and authenticated on GitHub Actions runners
      - name: Add PR Comment via GitHub CLI
        if: steps.build-source.outputs.is_pr == 'true'
        run: |-
          # Create comment message with emojis

          EMOJI="🤖"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Get the artifact links from previous step
          ARTIFACT_LINKS="${{ steps.fetch-android-artifacts.outputs.artifact_list }}"

          if [[ "$ARTIFACT_LINKS" == "No artifacts found" ]]; then
            DOWNLOAD_SECTION="📥 **Download**: No artifacts available"
          else
            DOWNLOAD_SECTION="📥 **Downloads**:\n\n$ARTIFACT_LINKS"
          fi

          MESSAGE="$EMOJI **Android release build completed! ✅**\n\n$DOWNLOAD_SECTION\n\n🔗 **Workflow**: [View Build
          Run](${WORKFLOW_URL})"

          # Check if comment already exists and update it

          PR_NUM="${{ github.event.number }}"

          SEARCH_TEXT="Android release build completed"

          echo "Creating new comment..."

          gh pr comment $PR_NUM --body "$MESSAGE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Slack Notification
        if: always()
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          payload: |-
            {
              "text": ":android: *Android release build* ${{ job.status == 'success' && ':rocket: Success' || job.status == 'failure' && ':boom: Failed' || ':warning: Warning' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": ":android: Android Build release",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ job.status == 'success' && ':white_check_mark: *Success*' || job.status == 'failure' && ':x: *Failed*' || ':warning: *Warning*' }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Downloads:*\n${{ steps.fetch-android-artifacts.outputs.artifact_list }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Build #${{ github.run_number }} | ${{ github.workflow }} workflow | <${{ github.server_url }}/${{ github.repository }}|android-release>"
                    }
                  ]
                }
              ]
            }